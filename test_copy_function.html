<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>测试复制和使用功能</title>
	<style>
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			max-width: 800px;
			margin: 0 auto;
			padding: 20px;
			line-height: 1.6;
			background: #1e1e1e;
			color: #cccccc;
		}

		.test-section {
			background: #2d2d30;
			border: 1px solid #464647;
			border-radius: 8px;
			padding: 20px;
			margin: 20px 0;
		}

		.btn {
			background: #0e639c;
			color: white;
			border: none;
			padding: 10px 16px;
			border-radius: 4px;
			cursor: pointer;
			margin: 5px;
			font-size: 14px;
		}

		.btn:hover {
			background: #1177bb;
		}

		.btn.secondary {
			background: #5a5a5a;
		}

		.btn.secondary:hover {
			background: #6a6a6a;
		}

		.status {
			padding: 10px;
			border-radius: 4px;
			margin: 10px 0;
			display: none;
		}

		.status.success {
			background: #365c03;
			border: 1px solid #46760a;
			color: #cccccc;
		}

		.status.error {
			background: #5a1d1d;
			border: 1px solid #f85149;
			color: #cccccc;
		}

		.stats {
			background: #2d2d30;
			border: 1px solid #464647;
			border-radius: 4px;
			padding: 15px;
			margin: 10px 0;
		}

		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
			gap: 15px;
		}

		.stat-item {
			text-align: center;
		}

		.stat-label {
			display: block;
			font-size: 12px;
			color: #999;
			margin-bottom: 5px;
		}

		.stat-value {
			display: block;
			font-size: 18px;
			font-weight: bold;
			color: #007acc;
		}

		textarea {
			width: 100%;
			height: 100px;
			background: #1e1e1e;
			border: 1px solid #464647;
			color: #cccccc;
			padding: 10px;
			border-radius: 4px;
			resize: vertical;
		}
	</style>
</head>

<body>
	<h1>🧪 Prompt功能测试页面</h1>

	<div class="test-section">
		<h3>📋 复制功能测试</h3>
		<p>测试不同的复制方案是否都能正常工作</p>

		<textarea id="testPrompt" placeholder="在这里输入要测试的Prompt内容...">
这是一个测试Prompt：
请帮我写一个排序算法，要求：
1. 使用Python语言
2. 实现快速排序
3. 添加详细注释
4. 包含测试用例

希望代码简洁易懂，性能良好。
        </textarea>

		<div style="margin-top: 10px;">
			<button class="btn" onclick="testCopyPrompt()">📋 测试复制功能</button>
			<button class="btn secondary" onclick="testFallbackCopy()">📋 测试降级复制</button>
			<button class="btn secondary" onclick="testManualCopy()">📋 测试手动复制</button>
		</div>

		<div id="copyStatus" class="status"></div>
	</div>

	<div class="test-section">
		<h3>✅ 使用功能测试</h3>
		<p>测试使用Prompt的完整流程</p>

		<button class="btn" onclick="testUsePrompt()">✅ 测试使用功能</button>
		<div id="useStatus" class="status"></div>
	</div>

	<div class="test-section">
		<h3>📊 统计数据</h3>
		<div id="promptUsageStats" class="stats">
			<div class="stats-grid">
				<div class="stat-item">
					<span class="stat-label">生成次数</span>
					<span class="stat-value">0</span>
				</div>
				<div class="stat-item">
					<span class="stat-label">使用次数</span>
					<span class="stat-value">0</span>
				</div>
				<div class="stat-item">
					<span class="stat-label">复制次数</span>
					<span class="stat-value">0</span>
				</div>
				<div class="stat-item">
					<span class="stat-label">使用占比</span>
					<span class="stat-value">0%</span>
				</div>
			</div>
		</div>
	</div>

	<script>
		// 模拟统计数据
		let promptUsageStats = {
			generateCount: 0,
			copyCount: 0,
			useCount: 0,
			optimizeCount: 0
		};

		// 模拟vscode接口
		const vscode = {
			postMessage: function (message) {
				console.log('📤 模拟发送消息到VSCode:', message);
				showStatus('useStatus', '✅ 消息已发送到VSCode (模拟)', 'success');
			}
		};

		// 显示状态消息
		function showStatus(elementId, message, type) {
			const statusEl = document.getElementById(elementId);
			statusEl.textContent = message;
			statusEl.className = `status ${type}`;
			statusEl.style.display = 'block';

			setTimeout(() => {
				statusEl.style.display = 'none';
			}, 3000);
		}

		// 复制Prompt到剪贴板
		function copyPrompt(prompt) {
			console.log('🔄 正在复制Prompt到剪贴板...');

			// 更新统计
			promptUsageStats.copyCount++;

			// 尝试使用现代API复制
			if (navigator.clipboard && window.isSecureContext) {
				navigator.clipboard.writeText(prompt).then(() => {
					console.log('✅ Prompt已复制到剪贴板');
					showStatus('copyStatus', '📋 Prompt已复制到剪贴板', 'success');
					// 发送统计数据
					sendUsageStats('copy');
				}).catch(err => {
					console.error('❌ 复制失败:', err);
					fallbackCopy(prompt);
				});
			} else {
				// 降级方案
				fallbackCopy(prompt);
			}
		}

		// 降级复制方案
		function fallbackCopy(prompt) {
			try {
				// 创建临时文本区域
				const textArea = document.createElement('textarea');
				textArea.value = prompt;
				textArea.style.position = 'fixed';
				textArea.style.left = '-999999px';
				textArea.style.top = '-999999px';
				document.body.appendChild(textArea);
				textArea.focus();
				textArea.select();

				const successful = document.execCommand('copy');
				document.body.removeChild(textArea);

				if (successful) {
					console.log('✅ Prompt已复制到剪贴板（降级方案）');
					showStatus('copyStatus', '📋 Prompt已复制到剪贴板（降级方案）', 'success');
					sendUsageStats('copy');
				} else {
					throw new Error('execCommand failed');
				}
			} catch (err) {
				console.error('❌ 降级复制也失败:', err);
				// 显示手动复制提示
				showManualCopyDialog(prompt);
			}
		}

		// 显示手动复制对话框
		function showManualCopyDialog(prompt) {
			const modal = document.createElement('div');
			modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

			const dialog = document.createElement('div');
			dialog.style.cssText = `
                background: #2d2d30;
                border: 1px solid #464647;
                border-radius: 8px;
                padding: 20px;
                max-width: 500px;
                width: 90%;
                max-height: 400px;
            `;

			dialog.innerHTML = `
                <h3 style="margin-top: 0; color: #cccccc;">手动复制 Prompt</h3>
                <p style="color: #999;">请手动选择并复制以下内容：</p>
                <textarea readonly style="
                    width: 100%;
                    height: 200px;
                    border: 1px solid #464647;
                    background: #1e1e1e;
                    color: #cccccc;
                    padding: 10px;
                    border-radius: 4px;
                    resize: vertical;
                ">${prompt}</textarea>
                <div style="text-align: right; margin-top: 15px;">
                    <button id="copyDialogClose" class="btn secondary">关闭</button>
                </div>
            `;

			modal.appendChild(dialog);
			document.body.appendChild(modal);

			// 自动选中文本
			const textarea = dialog.querySelector('textarea');
			setTimeout(() => {
				textarea.select();
				textarea.focus();
			}, 100);

			// 关闭按钮事件
			dialog.querySelector('#copyDialogClose').addEventListener('click', () => {
				document.body.removeChild(modal);
			});

			// 点击背景关闭
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					document.body.removeChild(modal);
				}
			});
		}

		// 使用生成的Prompt
		function usePrompt(prompt) {
			console.log('🚀 使用生成的Prompt...');

			// 更新统计
			promptUsageStats.useCount++;

			// 默认先复制内容
			copyPrompt(prompt);

			// 发送使用统计
			sendUsageStats('use');

			// 显示使用提示
			showStatus('useStatus', '✅ Prompt已复制，正在跳转到题目页面...', 'success');

			console.log('📝 模拟跳转到题目页面并自动填入Prompt');
		}

		// 发送使用统计数据
		function sendUsageStats(action) {
			try {
				// 发送统计数据到后端
				vscode.postMessage({
					command: 'recordPromptUsage',
					action: action,
					stats: promptUsageStats,
					timestamp: new Date().toISOString()
				});
				console.log(`📊 统计数据已发送: ${action}`, promptUsageStats);
				// 更新显示
				displayUsageStatistics();
			} catch (error) {
				console.error('❌ 发送统计数据失败:', error);
			}
		}

		// 获取使用统计占比
		function getUsageRatio() {
			const total = promptUsageStats.generateCount + promptUsageStats.optimizeCount;
			const useTotal = promptUsageStats.useCount;
			const copyTotal = promptUsageStats.copyCount;

			if (total === 0) return { useRatio: 0, copyRatio: 0, totalGenerated: 0, totalUsed: useTotal, totalCopied: copyTotal };

			return {
				useRatio: Math.round((useTotal / total) * 100),
				copyRatio: Math.round((copyTotal / total) * 100),
				totalGenerated: total,
				totalUsed: useTotal,
				totalCopied: copyTotal
			};
		}

		// 显示使用统计信息
		function displayUsageStatistics() {
			const ratio = getUsageRatio();
			console.log('📊 当前使用统计:', {
				生成次数: ratio.totalGenerated,
				使用次数: ratio.totalUsed,
				复制次数: ratio.totalCopied,
				使用占比: ratio.useRatio + '%',
				复制占比: ratio.copyRatio + '%'
			});

			// 更新统计显示元素
			const statsElement = document.getElementById('promptUsageStats');
			if (statsElement) {
				statsElement.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">生成次数</span>
                            <span class="stat-value">${ratio.totalGenerated}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">使用次数</span>
                            <span class="stat-value">${ratio.totalUsed}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">复制次数</span>
                            <span class="stat-value">${ratio.totalCopied}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">使用占比</span>
                            <span class="stat-value">${ratio.useRatio}%</span>
                        </div>
                    </div>
                `;
			}
		}

		// 测试函数
		function testCopyPrompt() {
			const prompt = document.getElementById('testPrompt').value;
			if (!prompt.trim()) {
				showStatus('copyStatus', '❌ 请先输入测试内容', 'error');
				return;
			}
			copyPrompt(prompt);
		}

		function testFallbackCopy() {
			const prompt = document.getElementById('testPrompt').value;
			if (!prompt.trim()) {
				showStatus('copyStatus', '❌ 请先输入测试内容', 'error');
				return;
			}
			fallbackCopy(prompt);
		}

		function testManualCopy() {
			const prompt = document.getElementById('testPrompt').value;
			if (!prompt.trim()) {
				showStatus('copyStatus', '❌ 请先输入测试内容', 'error');
				return;
			}
			showManualCopyDialog(prompt);
		}

		function testUsePrompt() {
			const prompt = document.getElementById('testPrompt').value;
			if (!prompt.trim()) {
				showStatus('useStatus', '❌ 请先输入测试内容', 'error');
				return;
			}
			usePrompt(prompt);
		}

		// 模拟生成按钮点击，增加生成统计
		function simulateGenerate() {
			promptUsageStats.generateCount++;
			sendUsageStats('generate');
		}

		// 页面加载时显示初始统计
		document.addEventListener('DOMContentLoaded', function () {
			displayUsageStatistics();

			// 添加一些模拟按钮
			const controlSection = document.createElement('div');
			controlSection.className = 'test-section';
			controlSection.innerHTML = `
                <h3>🎮 模拟操作</h3>
                <p>模拟生成和优化操作来测试统计功能</p>
                <button class="btn secondary" onclick="simulateGenerate()">📝 模拟生成Prompt</button>
                <button class="btn secondary" onclick="promptUsageStats.optimizeCount++; sendUsageStats('optimize');">🔧 模拟优化Prompt</button>
                <button class="btn secondary" onclick="promptUsageStats = {generateCount: 0, copyCount: 0, useCount: 0, optimizeCount: 0}; displayUsageStatistics();">🔄 重置统计</button>
            `;
			document.body.appendChild(controlSection);
		});
	</script>
</body>

</html>