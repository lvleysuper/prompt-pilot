<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Prompt生成功能测试</title>
	<style>
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			max-width: 800px;
			margin: 0 auto;
			padding: 20px;
			line-height: 1.6;
			background: #1e1e1e;
			color: #cccccc;
		}

		.test-section {
			background: #2d2d30;
			border: 1px solid #464647;
			border-radius: 8px;
			padding: 20px;
			margin: 20px 0;
		}

		.btn {
			background: #0e639c;
			color: white;
			border: none;
			padding: 10px 16px;
			border-radius: 4px;
			cursor: pointer;
			margin: 5px;
			font-size: 14px;
		}

		.btn:hover {
			background: #1177bb;
		}

		.btn.secondary {
			background: #5a5a5a;
		}

		.btn.secondary:hover {
			background: #6a6a6a;
		}

		.status {
			padding: 10px;
			border-radius: 4px;
			margin: 10px 0;
			display: none;
		}

		.status.success {
			background: #365c03;
			border: 1px solid #46760a;
			color: #cccccc;
		}

		.status.error {
			background: #5a1d1d;
			border: 1px solid #f85149;
			color: #cccccc;
		}

		pre {
			background: #1e1e1e;
			border: 1px solid #464647;
			border-radius: 4px;
			padding: 15px;
			overflow-x: auto;
			white-space: pre-wrap;
		}

		textarea {
			width: 100%;
			height: 100px;
			background: #1e1e1e;
			border: 1px solid #464647;
			color: #cccccc;
			padding: 10px;
			border-radius: 4px;
			resize: vertical;
		}

		.result-actions {
			margin-top: 15px;
			display: flex;
			gap: 10px;
		}

		#generatedPromptResult {
			margin-top: 20px;
			display: none;
		}
	</style>
</head>

<body>
	<h1>🧪 Prompt生成功能测试</h1>

	<div class="test-section">
		<h3>📝 任务描述输入</h3>
		<p>在下面输入您想要生成Prompt的任务描述：</p>

		<textarea id="taskDescription" placeholder="例如：我想写一个计算器应用，要求支持基本的四则运算...">我想写一个在线计算器，要求：
1. 支持基本的加减乘除运算
2. 有清晰的用户界面
3. 支持键盘输入
4. 包含清零和删除功能
5. 使用HTML、CSS、JavaScript实现</textarea>

		<div style="margin-top: 10px;">
			<button class="btn" onclick="testGeneratePrompt()">🚀 测试生成Prompt</button>
			<button class="btn secondary" onclick="testWithComplexPrompt()">🧮 测试复杂内容</button>
			<button class="btn secondary" onclick="testWithSpecialChars()">🔤 测试特殊字符</button>
		</div>

		<div id="status" class="status"></div>
	</div>

	<div id="generatedPromptResult" class="test-section">
		<!-- 生成的结果会显示在这里 -->
	</div>

	<div class="test-section">
		<h3>🔧 功能验证清单</h3>
		<ul>
			<li id="check1">✅ 能够输入任务描述</li>
			<li id="check2">⏳ 能够生成Prompt（待测试）</li>
			<li id="check3">⏳ 复制功能正常工作（待测试）</li>
			<li id="check4">⏳ 使用功能正常工作（待测试）</li>
			<li id="check5">⏳ 特殊字符处理正确（待测试）</li>
		</ul>
	</div>

	<script>
		// 模拟元素对象
		const elements = {
			generatedPromptResult: document.getElementById('generatedPromptResult')
		};

		// 模拟统计数据
		let promptUsageStats = {
			generateCount: 0,
			copyCount: 0,
			useCount: 0,
			optimizeCount: 0
		};

		// 模拟vscode接口
		const vscode = {
			postMessage: function (message) {
				console.log('📤 模拟发送消息到VSCode:', message);

				// 模拟后端响应
				setTimeout(() => {
					if (message.command === 'generatePrompt') {
						simulatePromptGenerated(message.task);
					}
				}, 1500);
			}
		};

		// 显示状态消息
		function showStatus(message, type) {
			const statusEl = document.getElementById('status');
			statusEl.textContent = message;
			statusEl.className = `status ${type}`;
			statusEl.style.display = 'block';

			setTimeout(() => {
				statusEl.style.display = 'none';
			}, 3000);
		}

		function showConfigStatus(message, type) {
			showStatus(message, type);
		}

		function showLoading(message) {
			showStatus(message, 'info');
		}

		function hideLoading() {
			document.getElementById('status').style.display = 'none';
		}

		// 模拟Prompt生成响应
		function simulatePromptGenerated(task) {
			let mockPrompt = '';

			if (task.includes('计算器') || task.includes('calculator')) {
				mockPrompt = `请你作为一名专业的前端开发工程师，创建一个功能完整的计算器应用。

## 功能要求：
1. 基本运算：加法(+)、减法(-)、乘法(×)、除法(÷)
2. 高级功能：清零(C)、删除(DEL)、小数点支持
3. 界面设计：现代化UI，响应式布局
4. 交互体验：键盘支持、错误处理

## 技术规范：
- 使用HTML5、CSS3、JavaScript
- 采用Grid布局设计按钮
- 实现键盘快捷键操作
- 添加动画效果和视觉反馈

## 输出要求：
请提供完整的HTML文件，包含内联CSS和JavaScript，确保可以直接在浏览器中运行。

## 特殊字符测试：
这里包含"双引号"、'单引号'、换行符
以及其他特殊字符：&、<、>、$、%、#
代码示例：
\`\`\`javascript
function calculate(a, b) {
    return a + b;
}
\`\`\``;
			} else {
				mockPrompt = `请你作为一名专业的软件开发工程师，完成以下任务：

## 任务描述：
${task}

## 实现要求：
1. 功能完整性：确保满足所有基本需求
2. 代码质量：遵循最佳实践和编码规范
3. 错误处理：完善的异常处理和边界情况考虑
4. 用户体验：直观易用的交互设计

## 技术规范：
- 选择合适的技术栈和工具
- 编写清晰的代码注释
- 遵循SOLID设计原则
- 考虑可维护性和可扩展性

## 输出要求：
请提供完整的实现方案，包括核心代码、使用说明和关键技术点解析。确保代码可以直接运行并达到预期效果。`;
			}

			handlePromptGenerated(mockPrompt);
			updateChecklist('check2', true);
		}

		// === 以下是修复后的核心函数 ===

		// 安全地转义HTML内容
		const escapeHtml = (str) => {
			return str.replace(/&/g, '&amp;')
				.replace(/</g, '&lt;')
				.replace(/>/g, '&gt;')
				.replace(/"/g, '&quot;')
				.replace(/'/g, '&#39;');
		};

		// 处理Prompt生成结果（修复后的版本）
		function handlePromptGenerated(prompt) {
			hideLoading();

			if (!elements.generatedPromptResult) return;

			// 创建按钮元素，避免字符串转义问题
			const resultContainer = document.createElement('div');
			resultContainer.innerHTML = `
                <h4>生成的 Prompt</h4>
                <pre>${escapeHtml(prompt)}</pre>
                <div class="result-actions" id="promptActions"></div>
            `;

			// 创建复制按钮
			const copyButton = document.createElement('button');
			copyButton.className = 'btn secondary';
			copyButton.innerHTML = '📋 复制';
			copyButton.addEventListener('click', () => {
				copyPrompt(prompt);
				updateChecklist('check3', true);
			});

			// 创建使用按钮
			const useButton = document.createElement('button');
			useButton.className = 'btn primary';
			useButton.innerHTML = '✅ 使用此 Prompt';
			useButton.addEventListener('click', () => {
				usePrompt(prompt);
				updateChecklist('check4', true);
			});

			// 创建分析按钮
			const analyzeButton = document.createElement('button');
			analyzeButton.className = 'btn secondary';
			analyzeButton.innerHTML = '📊 测试分析功能';
			analyzeButton.addEventListener('click', () => {
				testPromptAnalysis(prompt);
			});

			// 创建代码生成按钮
			const generateCodeButton = document.createElement('button');
			generateCodeButton.className = 'btn secondary';
			generateCodeButton.innerHTML = '🚀 测试代码生成';
			generateCodeButton.addEventListener('click', () => {
				testCodeGeneration(prompt);
			});

			// 添加按钮到容器
			const actionsContainer = resultContainer.querySelector('#promptActions');
			actionsContainer.appendChild(copyButton);
			actionsContainer.appendChild(useButton);
			actionsContainer.appendChild(analyzeButton);
			actionsContainer.appendChild(generateCodeButton);

			// 更新显示
			elements.generatedPromptResult.innerHTML = '';
			elements.generatedPromptResult.appendChild(resultContainer);
			elements.generatedPromptResult.style.display = 'block';
		}

		// 测试Prompt分析功能
		function testPromptAnalysis(prompt) {
			showStatus('正在测试Prompt分析功能...', 'info');

			// 模拟分析结果
			setTimeout(() => {
				const score = Math.floor(Math.random() * 30) + 65; // 65-95分

				// 根据分数生成对应的反馈内容
				let feedback = '';
				if (score >= 85) {
					feedback = `您的Prompt表现优秀（${score}分）！具有清晰的结构和明确的需求描述，技术要求具体，包含了完整的功能需求和技术栈选择。`;
				} else if (score >= 70) {
					feedback = `您的Prompt质量良好（${score}分）。包含了基本的问题描述和主要需求，在技术细节和限制条件方面可以进一步完善。`;
				} else {
					feedback = `您的Prompt需要改进（${score}分）。虽然包含了基本的问题描述，但在明确性、完整性和技术要求方面还有提升空间。`;
				}

				const mockAnalysis = {
					score: score,
					feedback: feedback,
					improvements: [
						'增加更具体的技术要求和约束条件',
						'提供示例输入输出以明确期望',
						'指定代码风格和最佳实践要求',
						'添加性能和边界情况考虑'
					]
				};
				handlePromptAnalyzed(mockAnalysis);
			}, 1000);
		}

		// 测试代码生成功能
		function testCodeGeneration(prompt) {
			showStatus('正在测试代码生成功能...', 'info');

			// 模拟代码生成结果
			setTimeout(() => {
				const mockCode = `// 模拟生成的TypeScript代码
class Calculator {
    private result: number = 0;

    /**
     * 执行加法运算
     * @param a 操作数A
     * @param b 操作数B
     * @returns 加法结果
     */
    add(a: number, b: number): number {
        try {
            this.result = a + b;
            return this.result;
        } catch (error) {
            throw new Error('加法运算失败: ' + error.message);
        }
    }

    /**
     * 获取当前结果
     */
    getResult(): number {
        return this.result;
    }
}

// 使用示例
const calc = new Calculator();
console.log(calc.add(2, 3)); // 输出: 5`;

				const mockResponse = {
					success: true,
					generatedCode: mockCode,
					explanation: '这是一个简单的计算器类实现，包含了完整的TypeScript类型注解、错误处理和详细注释。代码遵循了面向对象的设计原则，具有良好的可读性和可维护性。'
				};
				handleCodeGenerated(mockResponse);
			}, 1200);
		}

		// 复制Prompt到剪贴板
		function copyPrompt(prompt) {
			console.log('🔄 正在复制Prompt到剪贴板...');

			// 更新统计
			promptUsageStats.copyCount++;

			// 尝试使用现代API复制
			if (navigator.clipboard && window.isSecureContext) {
				navigator.clipboard.writeText(prompt).then(() => {
					console.log('✅ Prompt已复制到剪贴板');
					showConfigStatus('📋 Prompt已复制到剪贴板', 'success');
				}).catch(err => {
					console.error('❌ 复制失败:', err);
					fallbackCopy(prompt);
				});
			} else {
				// 降级方案
				fallbackCopy(prompt);
			}
		}

		// 降级复制方案
		function fallbackCopy(prompt) {
			try {
				// 创建临时文本区域
				const textArea = document.createElement('textarea');
				textArea.value = prompt;
				textArea.style.position = 'fixed';
				textArea.style.left = '-999999px';
				textArea.style.top = '-999999px';
				document.body.appendChild(textArea);
				textArea.focus();
				textArea.select();

				const successful = document.execCommand('copy');
				document.body.removeChild(textArea);

				if (successful) {
					console.log('✅ Prompt已复制到剪贴板（降级方案）');
					showConfigStatus('📋 Prompt已复制到剪贴板（降级方案）', 'success');
				} else {
					throw new Error('execCommand failed');
				}
			} catch (err) {
				console.error('❌ 降级复制也失败:', err);
				showConfigStatus('❌ 复制失败，请手动复制内容', 'error');
			}
		}

		// 使用生成的Prompt
		function usePrompt(prompt) {
			console.log('🚀 使用生成的Prompt...');

			// 更新统计
			promptUsageStats.useCount++;

			// 复制内容到剪贴板
			copyPrompt(prompt);

			// 发送使用统计
			sendUsageStats('use');

			// 显示接纳确认
			showConfigStatus('✅ Prompt已接纳并复制到剪贴板', 'success');

			// 显示统计信息
			const ratio = getUsageRatio();
			console.log(`📊 接纳统计: 接纳次数 ${ratio.totalUsed}, 接纳率 ${ratio.useRatio}%`);
		}

		// 发送使用统计数据
		function sendUsageStats(action) {
			try {
				// 发送统计数据到后端
				vscode.postMessage({
					command: 'recordPromptUsage',
					action: action,
					stats: promptUsageStats,
					timestamp: new Date().toISOString()
				});
				console.log(`📊 统计数据已发送: ${action}`, promptUsageStats);
				// 更新显示
				displayUsageStatistics();
			} catch (error) {
				console.error('❌ 发送统计数据失败:', error);
			}
		}

		// 获取使用统计占比
		function getUsageRatio() {
			const totalGenerated = promptUsageStats.generateCount + promptUsageStats.optimizeCount;
			const totalUsed = promptUsageStats.useCount;
			const totalCopied = promptUsageStats.copyCount;

			// 计算接纳率（使用次数 / 生成次数）
			const acceptanceRate = totalGenerated === 0 ? 0 : Math.round((totalUsed / totalGenerated) * 100);
			// 计算复制率（复制次数 / 生成次数）
			const copyRate = totalGenerated === 0 ? 0 : Math.round((totalCopied / totalGenerated) * 100);

			return {
				useRatio: acceptanceRate,        // 接纳率
				copyRatio: copyRate,             // 复制率
				totalGenerated: totalGenerated,  // 总生成次数
				totalUsed: totalUsed,            // 总接纳次数
				totalCopied: totalCopied,        // 总复制次数
				acceptanceRate: acceptanceRate   // 接纳率（别名）
			};
		}

		// 显示使用统计信息
		function displayUsageStatistics() {
			const ratio = getUsageRatio();
			console.log('📊 当前使用统计:', {
				生成次数: ratio.totalGenerated,
				接纳次数: ratio.totalUsed,
				复制次数: ratio.totalCopied,
				接纳率: ratio.acceptanceRate + '%',
				复制率: ratio.copyRate + '%'
			});

			// 更新统计显示元素
			const statsElement = document.getElementById('promptUsageStats');
			if (statsElement) {
				statsElement.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">生成次数</span>
                            <span class="stat-value">${ratio.totalGenerated}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">接纳次数</span>
                            <span class="stat-value">${ratio.totalUsed}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">复制次数</span>
                            <span class="stat-value">${ratio.totalCopied}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">接纳率</span>
                            <span class="stat-value">${ratio.acceptanceRate}%</span>
                        </div>
                    </div>
                `;
			}
		}

		// 测试函数
		function testGeneratePrompt() {
			const task = document.getElementById('taskDescription').value.trim();
			if (!task) {
				showStatus('❌ 请先输入任务描述', 'error');
				return;
			}

			showLoading('正在生成Prompt...');

			// 模拟发送到后端
			vscode.postMessage({
				command: 'generatePrompt',
				task: task
			});
		}

		function testWithComplexPrompt() {
			document.getElementById('taskDescription').value = `我需要一个复杂的Web应用：
1. 用户认证系统（登录/注册）
2. 数据可视化仪表板
3. 实时聊天功能
4. 文件上传和管理
5. 响应式设计
6. API接口设计
包含"特殊字符"：双引号、'单引号'、&符号、<标签>等
代码示例：
function test() {
    console.log("Hello 'World'!");
    return a < b && c > d;
}`;
			testGeneratePrompt();
		}

		function testWithSpecialChars() {
			document.getElementById('taskDescription').value = `测试特殊字符处理：
"双引号内容"
'单引号内容'
HTML标签<div>内容</div>
JavaScript代码：
var msg = "Hello 'World'!";
if (a < b && c > d) {
    console.log('成功处理特殊字符');
}
换行符
和制表符测试`;
			testGeneratePrompt();
			updateChecklist('check5', true);
		}

		// 更新验证清单
		function updateChecklist(checkId, success) {
			const element = document.getElementById(checkId);
			if (success) {
				element.innerHTML = element.innerHTML.replace('⏳', '✅');
			} else {
				element.innerHTML = element.innerHTML.replace('⏳', '❌');
			}
		}

		// 页面加载完成后初始化
		document.addEventListener('DOMContentLoaded', function () {
			console.log('🧪 测试页面已加载，准备开始测试...');
		});

		// 处理Prompt分析结果
		function handlePromptAnalyzed(analysis) {
			hideLoading();

			// 安全地转义HTML内容
			const escapeHtml = (str) => {
				return str.replace(/&/g, '&amp;')
					.replace(/</g, '&lt;')
					.replace(/>/g, '&gt;')
					.replace(/"/g, '&quot;')
					.replace(/'/g, '&#39;');
			};

			// 创建结构化的分析结果
			const resultContainer = document.createElement('div');
			resultContainer.className = 'prompt-analysis-result';

			// 分数等级判断
			const score = analysis.score || 0;
			let scoreLevel = 'low';
			let scoreIcon = '🔴';
			let scoreText = '需要改进';

			if (score >= 80) {
				scoreLevel = 'high';
				scoreIcon = '🟢';
				scoreText = '优秀';
			} else if (score >= 60) {
				scoreLevel = 'medium';
				scoreIcon = '🟡';
				scoreText = '良好';
			}

			// 添加分析结果的HTML结构
			resultContainer.innerHTML = `
				<div class="analysis-header">
					<h4><i class="icon">📊</i> Prompt 质量分析报告</h4>
					<div class="analysis-timestamp">🕰️ ${new Date().toLocaleString()}</div>
				</div>
				<div class="analysis-score-card">
					<div class="score-circle ${scoreLevel}">
						<div class="score-number">${score}</div>
						<div class="score-total">/100</div>
					</div>
					<div class="score-details">
						<div class="score-level">${scoreIcon} ${scoreText}</div>
						<div class="score-description">综合评估结果</div>
					</div>
				</div>
				<div class="analysis-sections">
					<div class="analysis-section">
						<div class="section-header">
							<i class="icon">📝</i>
							<h5>详细反馈</h5>
						</div>
						<div class="section-content">
							${escapeHtml(analysis.feedback || '分析完成')}
						</div>
					</div>
				</div>
			`;

			// 显示结果
			const analysisContainer = document.getElementById('promptAnalysisResult') || document.body;
			analysisContainer.appendChild(resultContainer);
			showStatus('✅ Prompt分析完成！', 'success');
		}

		// 处理代码生成结果
		function handleCodeGenerated(response) {
			hideLoading();

			if (!response.success) {
				showStatus('❗ 代码生成失败: ' + (response.error || '未知错误'), 'error');
				return;
			}

			const generatedCode = response.generatedCode;

			// 创建结构化的代码生成结果
			const resultContainer = document.createElement('div');
			resultContainer.className = 'code-generation-result';

			// 分析代码统计信息
			const codeLines = generatedCode.split('\n').length;
			const codeSize = new Blob([generatedCode]).size;
			const functions = (generatedCode.match(/function\s+\w+|\w+\s*=\s*\([^)]*\)\s*=>/g) || []).length;
			const classes = (generatedCode.match(/class\s+\w+/g) || []).length;

			// 添加代码结果的HTML结构
			resultContainer.innerHTML = `
				<div class="code-header">
					<h4><i class="icon">🚀</i> 代码生成完成</h4>
					<div class="code-meta">
						<span>🕰️ ${new Date().toLocaleTimeString()}</span>
						<span>📏 ${codeLines} 行</span>
					</div>
				</div>
				<div class="code-content">
					<div class="code-block">
						<div class="code-block-header">
							<span class="code-language">TypeScript</span>
							<button class="copy-code-btn" onclick="copyPrompt('${generatedCode.replace(/'/g, "\\'")}')">📋 复制代码</button>
						</div>
						<pre>${escapeHtml(generatedCode)}</pre>
					</div>
				</div>
			`;

			// 显示结果
			const codeContainer = document.getElementById('codeGenerationResult') || document.body;
			codeContainer.appendChild(resultContainer);
			showStatus('✅ 代码生成完成！', 'success');
		}
	</script>
</body>

</html>